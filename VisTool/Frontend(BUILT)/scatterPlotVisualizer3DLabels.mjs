/* Copyright 2016 The TensorFlow Authors. All Rights Reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
==============================================================================*/
import * as THREE from 'three';
import * as util from './util';
const FONT_SIZE = 80;
const ONE_OVER_FONT_SIZE = 1 / FONT_SIZE;
const LABEL_SCALE = 2.2; // at 1:1 texel/pixel ratio
const LABEL_COLOR = 'black';
const CUSTOM_COLOR = 'green';
const LABEL_BACKGROUND = 'white';
const MAX_CANVAS_DIMENSION = 8192;
const NUM_GLYPHS = 256;
const RGB_ELEMENTS_PER_ENTRY = 3;
const XYZ_ELEMENTS_PER_ENTRY = 3;
const UV_ELEMENTS_PER_ENTRY = 2;
const VERTICES_PER_GLYPH = 2 * 3; // 2 triangles, 3 verts per triangle
/**
 * Each label is made up of triangles (two per letter.) Each vertex, then, is
 * the corner of one of these triangles (and thus the corner of a letter
 * rectangle.)
 * Each has the following attributes:
 *    posObj: The (x, y) position of the vertex within the label, where the
 *            bottom center of the word is positioned at (0, 0);
 *    position: The position of the label in worldspace.
 *    vUv: The (u, v) coordinates that index into the glyphs sheet (range 0, 1.)
 *    color: The color of the label (matches the corresponding point's color.)
 *    wordShown: Boolean. Whether or not the label is visible.
 */
const VERTEX_SHADER = `
    attribute vec2 posObj;
    attribute vec3 color;
    varying vec2 vUv;
    varying vec3 vColor;

    void main() {
      vUv = uv;
      vColor = color;

      // Rotate label to face camera.

      vec4 vRight = vec4(
        modelViewMatrix[0][0], modelViewMatrix[1][0], modelViewMatrix[2][0], 0);

      vec4 vUp = vec4(
        modelViewMatrix[0][1], modelViewMatrix[1][1], modelViewMatrix[2][1], 0);

      vec4 vAt = -vec4(
        modelViewMatrix[0][2], modelViewMatrix[1][2], modelViewMatrix[2][2], 0);

      mat4 pointToCamera = mat4(vRight, vUp, vAt, vec4(0, 0, 0, 1));

      vec2 scaledPos = posObj * ${ONE_OVER_FONT_SIZE} * ${LABEL_SCALE};

      vec4 posRotated = pointToCamera * vec4(scaledPos, 0, 1);
      vec4 mvPosition = modelViewMatrix * (vec4(position, 0) + posRotated);
      gl_Position = projectionMatrix * mvPosition;
    }`;
const FRAGMENT_SHADER = `
    uniform sampler2D texture;
    uniform bool picking;
    varying vec2 vUv;
    varying vec3 vColor;

    void main() {
      if (picking) {
        gl_FragColor = vec4(vColor, 1.0);
      } else {
        vec4 fromTexture = texture2D(texture, vUv);
        gl_FragColor = vec4(vColor, 1.0) * fromTexture;
      }
    }`;
/**
 * Renders the text labels as 3d geometry in the world.
 */
export class ScatterPlotVisualizer3DLabels {
    createGlyphTexture() {
        let canvas = document.createElement('canvas');
        canvas.width = MAX_CANVAS_DIMENSION;
        canvas.height = FONT_SIZE;
        let ctx = canvas.getContext('2d');
        ctx.font = 'bold ' + FONT_SIZE * 0.75 + 'px roboto';
        ctx.textBaseline = 'top';
        ctx.fillStyle = LABEL_BACKGROUND;
        ctx.rect(0, 0, canvas.width, canvas.height);
        ctx.fill();
        ctx.fillStyle = LABEL_COLOR;
        let spaceOffset = ctx.measureText(' ').width;
        // For each letter, store length, position at the encoded index.
        let glyphLengths = new Float32Array(NUM_GLYPHS);
        let glyphOffset = new Float32Array(NUM_GLYPHS);
        let leftCoord = 0;
        for (let i = 0; i < NUM_GLYPHS; i++) {
            let text = ' ' + String.fromCharCode(i);
            let textLength = ctx.measureText(text).width;
            glyphLengths[i] = textLength - spaceOffset;
            glyphOffset[i] = leftCoord;
            ctx.fillText(text, leftCoord - spaceOffset, 0);
            leftCoord += textLength;
        }
        const tex = util.createTexture(canvas);
        return { texture: tex, lengths: glyphLengths, offsets: glyphOffset };
    }
    processLabelVerts(pointCount) {
        let numTotalLetters = 0;
        this.labelVertexMap = [];
        for (let i = 0; i < pointCount; i++) {
            const label = this.labelStrings[i];
            let vertsArray = [];
            for (let j = 0; j < label.length; j++) {
                for (let k = 0; k < VERTICES_PER_GLYPH; k++) {
                    vertsArray.push(numTotalLetters * VERTICES_PER_GLYPH + k);
                }
                numTotalLetters++;
            }
            this.labelVertexMap.push(vertsArray);
        }
        this.totalVertexCount = numTotalLetters * VERTICES_PER_GLYPH;
    }
    createColorBuffers(pointCount) {
        this.pickingColors = new Float32Array(this.totalVertexCount * RGB_ELEMENTS_PER_ENTRY);
        this.renderColors = new Float32Array(this.totalVertexCount * RGB_ELEMENTS_PER_ENTRY);
        for (let i = 0; i < pointCount; i++) {
            let color = new THREE.Color(i);
            this.labelVertexMap[i].forEach((j) => {
                this.pickingColors[RGB_ELEMENTS_PER_ENTRY * j] = color.r;
                this.pickingColors[RGB_ELEMENTS_PER_ENTRY * j + 1] = color.g;
                this.pickingColors[RGB_ELEMENTS_PER_ENTRY * j + 2] = color.b;
                this.renderColors[RGB_ELEMENTS_PER_ENTRY * j] = 1;
                this.renderColors[RGB_ELEMENTS_PER_ENTRY * j + 1] = 1;
                this.renderColors[RGB_ELEMENTS_PER_ENTRY * j + 2] = 1;
            });
        }
    }
    createLabels() {
        if (this.labelStrings == null || this.worldSpacePointPositions == null) {
            return;
        }
        const pointCount = this.worldSpacePointPositions.length / XYZ_ELEMENTS_PER_ENTRY;
        if (pointCount !== this.labelStrings.length) {
            return;
        }
        this.glyphTexture = this.createGlyphTexture();
        this.uniforms = {
            texture: { type: 't' },
            picking: { type: 'bool' },
        };
        this.material = new THREE.ShaderMaterial({
            uniforms: this.uniforms,
            transparent: true,
            vertexShader: VERTEX_SHADER,
            fragmentShader: FRAGMENT_SHADER,
        });
        this.processLabelVerts(pointCount);
        this.createColorBuffers(pointCount);
        let positionArray = new Float32Array(this.totalVertexCount * XYZ_ELEMENTS_PER_ENTRY);
        this.positions = new THREE.BufferAttribute(positionArray, XYZ_ELEMENTS_PER_ENTRY);
        let posArray = new Float32Array(this.totalVertexCount * XYZ_ELEMENTS_PER_ENTRY);
        let uvArray = new Float32Array(this.totalVertexCount * UV_ELEMENTS_PER_ENTRY);
        let colorsArray = new Float32Array(this.totalVertexCount * RGB_ELEMENTS_PER_ENTRY);
        let positionObject = new THREE.BufferAttribute(posArray, 2);
        let uv = new THREE.BufferAttribute(uvArray, UV_ELEMENTS_PER_ENTRY);
        let colors = new THREE.BufferAttribute(colorsArray, RGB_ELEMENTS_PER_ENTRY);
        this.geometry = new THREE.BufferGeometry();
        this.geometry.addAttribute('posObj', positionObject);
        this.geometry.addAttribute('position', this.positions);
        this.geometry.addAttribute('uv', uv);
        this.geometry.addAttribute('color', colors);
        let lettersSoFar = 0;
        for (let i = 0; i < pointCount; i++) {
            const label = this.labelStrings[i];
            let leftOffset = 0;
            // Determine length of word in pixels.
            for (let j = 0; j < label.length; j++) {
                let letterCode = label.charCodeAt(j);
                leftOffset += this.glyphTexture.lengths[letterCode];
            }
            leftOffset /= -2; // centers text horizontally around the origin
            for (let j = 0; j < label.length; j++) {
                let letterCode = label.charCodeAt(j);
                let letterWidth = this.glyphTexture.lengths[letterCode];
                let scale = FONT_SIZE;
                let right = (leftOffset + letterWidth) / scale;
                let left = leftOffset / scale;
                let top = FONT_SIZE / scale;
                // First triangle
                if (window.unLabelData.indexOf(i) !== -1) {
                    positionObject.setXY(lettersSoFar * VERTICES_PER_GLYPH + 0, left, 0);
                    positionObject.setXY(lettersSoFar * VERTICES_PER_GLYPH + 1, right, 0);
                    positionObject.setXY(lettersSoFar * VERTICES_PER_GLYPH + 2, left, top);
                    // Second triangle
                    positionObject.setXY(lettersSoFar * VERTICES_PER_GLYPH + 3, left, top);
                    positionObject.setXY(lettersSoFar * VERTICES_PER_GLYPH + 4, right, 0);
                    positionObject.setXY(lettersSoFar * VERTICES_PER_GLYPH + 5, right, top);
                }
                // Set UVs based on letter.
                let uLeft = this.glyphTexture.offsets[letterCode];
                let uRight = this.glyphTexture.offsets[letterCode] + letterWidth;
                // Scale so that uvs lie between 0 and 1 on the texture.
                uLeft /= MAX_CANVAS_DIMENSION;
                uRight /= MAX_CANVAS_DIMENSION;
                let vTop = 1;
                let vBottom = 0;
                uv.setXY(lettersSoFar * VERTICES_PER_GLYPH + 0, uLeft, vTop);
                uv.setXY(lettersSoFar * VERTICES_PER_GLYPH + 1, uRight, vTop);
                uv.setXY(lettersSoFar * VERTICES_PER_GLYPH + 2, uLeft, vBottom);
                uv.setXY(lettersSoFar * VERTICES_PER_GLYPH + 3, uLeft, vBottom);
                uv.setXY(lettersSoFar * VERTICES_PER_GLYPH + 4, uRight, vTop);
                uv.setXY(lettersSoFar * VERTICES_PER_GLYPH + 5, uRight, vBottom);
                lettersSoFar++;
                leftOffset += letterWidth;
            }
        }
        for (let i = 0; i < pointCount; i++) {
            const p = util.vector3FromPackedArray(this.worldSpacePointPositions, i);
            this.labelVertexMap[i].forEach((j) => {
                this.positions.setXYZ(j, p.x, p.y, p.z);
            });
        }
        this.labelsMesh = new THREE.Mesh(this.geometry, this.material);
        this.labelsMesh.frustumCulled = false;
        this.scene.add(this.labelsMesh);
    }
    colorLabels(pointColors) {
        if (this.labelStrings == null ||
            this.geometry == null ||
            pointColors == null) {
            return;
        }
        const colors = this.geometry.getAttribute('color');
        colors.setArray(this.renderColors);
        const n = pointColors.length / XYZ_ELEMENTS_PER_ENTRY;
        let src = 0;
        for (let i = 0; i < n; ++i) {
            const c = new THREE.Color(pointColors[src], pointColors[src + 1], pointColors[src + 2]);
            const m = this.labelVertexMap[i].length;
            for (let j = 0; j < m; ++j) {
                colors.setXYZ(this.labelVertexMap[i][j], c.r, c.g, c.b);
            }
            src += RGB_ELEMENTS_PER_ENTRY;
        }
        colors.needsUpdate = true;
    }
    setScene(scene) {
        this.scene = scene;
    }
    dispose() {
        if (this.labelsMesh) {
            if (this.scene) {
                this.scene.remove(this.labelsMesh);
            }
            this.labelsMesh = null;
        }
        if (this.geometry) {
            this.geometry.dispose();
            this.geometry = null;
        }
        if (this.glyphTexture != null && this.glyphTexture.texture != null) {
            this.glyphTexture.texture.dispose();
            this.glyphTexture.texture = null;
        }
    }
    onPickingRender(rc) {
        if (this.geometry == null) {
            this.createLabels();
        }
        if (this.geometry == null) {
            return;
        }
        this.material.uniforms.texture.value = this.glyphTexture.texture;
        this.material.uniforms.picking.value = true;
        const colors = this.geometry.getAttribute('color');
        colors.setArray(this.pickingColors);
        colors.needsUpdate = true;
    }
    onRender(rc) {
        if (this.geometry == null) {
            this.createLabels();
        }
        if (this.geometry == null) {
            return;
        }
        this.colorLabels(rc.pointColors);
        this.material.uniforms.texture.value = this.glyphTexture.texture;
        this.material.uniforms.picking.value = false;
        const colors = this.geometry.getAttribute('color');
        colors.setArray(this.renderColors);
        colors.needsUpdate = true;
    }
    onPointPositionsChanged(newPositions) {
        this.worldSpacePointPositions = newPositions;
        this.dispose();
    }
    setLabelStrings(labelStrings) {
        this.labelStrings = labelStrings;
        this.dispose();
    }
    onResize(newWidth, newHeight) { }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NhdHRlclBsb3RWaXN1YWxpemVyM0RMYWJlbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi90ZW5zb3Jib2FyZC9wcm9qZWN0b3Ivc2NhdHRlclBsb3RWaXN1YWxpemVyM0RMYWJlbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7Z0ZBYWdGO0FBQ2hGLE9BQU8sS0FBSyxLQUFLLE1BQU0sT0FBTyxDQUFDO0FBSS9CLE9BQU8sS0FBSyxJQUFJLE1BQU0sUUFBUSxDQUFDO0FBRS9CLE1BQU0sU0FBUyxHQUFHLEVBQUUsQ0FBQztBQUNyQixNQUFNLGtCQUFrQixHQUFHLENBQUMsR0FBRyxTQUFTLENBQUM7QUFDekMsTUFBTSxXQUFXLEdBQUcsR0FBRyxDQUFDLENBQUMsMkJBQTJCO0FBQ3BELE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQztBQUM1QixNQUFNLFlBQVksR0FBRyxPQUFPLENBQUM7QUFDN0IsTUFBTSxnQkFBZ0IsR0FBRyxPQUFPLENBQUM7QUFDakMsTUFBTSxvQkFBb0IsR0FBRyxJQUFJLENBQUM7QUFDbEMsTUFBTSxVQUFVLEdBQUcsR0FBRyxDQUFDO0FBQ3ZCLE1BQU0sc0JBQXNCLEdBQUcsQ0FBQyxDQUFDO0FBQ2pDLE1BQU0sc0JBQXNCLEdBQUcsQ0FBQyxDQUFDO0FBQ2pDLE1BQU0scUJBQXFCLEdBQUcsQ0FBQyxDQUFDO0FBQ2hDLE1BQU0sa0JBQWtCLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLG9DQUFvQztBQUN0RTs7Ozs7Ozs7Ozs7R0FXRztBQUNILE1BQU0sYUFBYSxHQUFHOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztrQ0F1Qlksa0JBQWtCLE1BQU0sV0FBVzs7Ozs7TUFLL0QsQ0FBQztBQUNQLE1BQU0sZUFBZSxHQUFHOzs7Ozs7Ozs7Ozs7O01BYWxCLENBQUM7QUFNUDs7R0FFRztBQUNILE1BQU0sT0FBTyw2QkFBNkI7SUFjaEMsa0JBQWtCO1FBQ3hC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MDE2IFRoZSBUZW5zb3JGbG93IEF1dGhvcnMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbmltcG9ydCAqIGFzIFRIUkVFIGZyb20gJ3RocmVlJztcblxuaW1wb3J0IHtSZW5kZXJDb250ZXh0fSBmcm9tICcuL3JlbmRlckNvbnRleHQnO1xuaW1wb3J0IHtTY2F0dGVyUGxvdFZpc3VhbGl6ZXJ9IGZyb20gJy4vc2NhdHRlclBsb3RWaXN1YWxpemVyJztcbmltcG9ydCAqIGFzIHV0aWwgZnJvbSAnLi91dGlsJztcblxuY29uc3QgRk9OVF9TSVpFID0gODA7XG5jb25zdCBPTkVfT1ZFUl9GT05UX1NJWkUgPSAxIC8gRk9OVF9TSVpFO1xuY29uc3QgTEFCRUxfU0NBTEUgPSAyLjI7IC8vIGF0IDE6MSB0ZXhlbC9waXhlbCByYXRpb1xuY29uc3QgTEFCRUxfQ09MT1IgPSAnYmxhY2snO1xuY29uc3QgQ1VTVE9NX0NPTE9SID0gJ2dyZWVuJztcbmNvbnN0IExBQkVMX0JBQ0tHUk9VTkQgPSAnd2hpdGUnO1xuY29uc3QgTUFYX0NBTlZBU19ESU1FTlNJT04gPSA4MTkyO1xuY29uc3QgTlVNX0dMWVBIUyA9IDI1NjtcbmNvbnN0IFJHQl9FTEVNRU5UU19QRVJfRU5UUlkgPSAzO1xuY29uc3QgWFlaX0VMRU1FTlRTX1BFUl9FTlRSWSA9IDM7XG5jb25zdCBVVl9FTEVNRU5UU19QRVJfRU5UUlkgPSAyO1xuY29uc3QgVkVSVElDRVNfUEVSX0dMWVBIID0gMiAqIDM7IC8vIDIgdHJpYW5nbGVzLCAzIHZlcnRzIHBlciB0cmlhbmdsZVxuLyoqXG4gKiBFYWNoIGxhYmVsIGlzIG1hZGUgdXAgb2YgdHJpYW5nbGVzICh0d28gcGVyIGxldHRlci4pIEVhY2ggdmVydGV4LCB0aGVuLCBpc1xuICogdGhlIGNvcm5lciBvZiBvbmUgb2YgdGhlc2UgdHJpYW5nbGVzIChhbmQgdGh1cyB0aGUgY29ybmVyIG9mIGEgbGV0dGVyXG4gKiByZWN0YW5nbGUuKVxuICogRWFjaCBoYXMgdGhlIGZvbGxvd2luZyBhdHRyaWJ1dGVzOlxuICogICAgcG9zT2JqOiBUaGUgKHgsIHkpIHBvc2l0aW9uIG9mIHRoZSB2ZXJ0ZXggd2l0aGluIHRoZSBsYWJlbCwgd2hlcmUgdGhlXG4gKiAgICAgICAgICAgIGJvdHRvbSBjZW50ZXIgb2YgdGhlIHdvcmQgaXMgcG9zaXRpb25lZCBhdCAoMCwgMCk7XG4gKiAgICBwb3NpdGlvbjogVGhlIHBvc2l0aW9uIG9mIHRoZSBsYWJlbCBpbiB3b3JsZHNwYWNlLlxuICogICAgdlV2OiBUaGUgKHUsIHYpIGNvb3JkaW5hdGVzIHRoYXQgaW5kZXggaW50byB0aGUgZ2x5cGhzIHNoZWV0IChyYW5nZSAwLCAxLilcbiAqICAgIGNvbG9yOiBUaGUgY29sb3Igb2YgdGhlIGxhYmVsIChtYXRjaGVzIHRoZSBjb3JyZXNwb25kaW5nIHBvaW50J3MgY29sb3IuKVxuICogICAgd29yZFNob3duOiBCb29sZWFuLiBXaGV0aGVyIG9yIG5vdCB0aGUgbGFiZWwgaXMgdmlzaWJsZS5cbiAqL1xuY29uc3QgVkVSVEVYX1NIQURFUiA9IGBcbiAgICBhdHRyaWJ1dGUgdmVjMiBwb3NPYmo7XG4gICAgYXR0cmlidXRlIHZlYzMgY29sb3I7XG4gICAgdmFyeWluZyB2ZWMyIHZVdjtcbiAgICB2YXJ5aW5nIHZlYzMgdkNvbG9yO1xuXG4gICAgdm9pZCBtYWluKCkge1xuICAgICAgdlV2ID0gdXY7XG4gICAgICB2Q29sb3IgPSBjb2xvcjtcblxuICAgICAgLy8gUm90YXRlIGxhYmVsIHRvIGZhY2UgY2FtZXJhLlxuXG4gICAgICB2ZWM0IHZSaWdodCA9IHZlYzQoXG4gICAgICAgIG1vZGVsVmlld01hdHJpeFswXVswXSwgbW9kZWxWaWV3TWF0cml4WzFdWzBdLCBtb2RlbFZpZXdNYXRyaXhbMl1bMF0sIDApO1xuXG4gICAgICB2ZWM0IHZVcCA9IHZlYzQoXG4gICAgICAgIG1vZGVsVmlld01hdHJpeFswXVsxXSwgbW9kZWxWaWV3TWF0cml4WzFdWzFdLCBtb2RlbFZpZXdNYXRyaXhbMl1bMV0sIDApO1xuXG4gICAgICB2ZWM0IHZBdCA9IC12ZWM0KFxuICAgICAgICBtb2RlbFZpZXdNYXRyaXhbMF1bMl0sIG1vZGVsVmlld01hdHJpeFsxXVsyXSwgbW9kZWxWaWV3TWF0cml4WzJdWzJdLCAwKTtcblxuICAgICAgbWF0NCBwb2ludFRvQ2FtZXJhID0gbWF0NCh2UmlnaHQsIHZVcCwgdkF0LCB2ZWM0KDAsIDAsIDAsIDEpKTtcblxuICAgICAgdmVjMiBzY2FsZWRQb3MgPSBwb3NPYmogKiAke09ORV9PVkVSX0ZPTlRfU0laRX0gKiAke0xBQkVMX1NDQUxFfTtcblxuICAgICAgdmVjNCBwb3NSb3RhdGVkID0gcG9pbnRUb0NhbWVyYSAqIHZlYzQoc2NhbGVkUG9zLCAwLCAxKTtcbiAgICAgIHZlYzQgbXZQb3NpdGlvbiA9IG1vZGVsVmlld01hdHJpeCAqICh2ZWM0KHBvc2l0aW9uLCAwKSArIHBvc1JvdGF0ZWQpO1xuICAgICAgZ2xfUG9zaXRpb24gPSBwcm9qZWN0aW9uTWF0cml4ICogbXZQb3NpdGlvbjtcbiAgICB9YDtcbmNvbnN0IEZSQUdNRU5UX1NIQURFUiA9IGBcbiAgICB1bmlmb3JtIHNhbXBsZXIyRCB0ZXh0dXJlO1xuICAgIHVuaWZvcm0gYm9vbCBwaWNraW5nO1xuICAgIHZhcnlpbmcgdmVjMiB2VXY7XG4gICAgdmFyeWluZyB2ZWMzIHZDb2xvcjtcblxuICAgIHZvaWQgbWFpbigpIHtcbiAgICAgIGlmIChwaWNraW5nKSB7XG4gICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQodkNvbG9yLCAxLjApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdmVjNCBmcm9tVGV4dHVyZSA9IHRleHR1cmUyRCh0ZXh0dXJlLCB2VXYpO1xuICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KHZDb2xvciwgMS4wKSAqIGZyb21UZXh0dXJlO1xuICAgICAgfVxuICAgIH1gO1xudHlwZSBHbHlwaFRleHR1cmUgPSB7XG4gIHRleHR1cmU6IFRIUkVFLlRleHR1cmU7XG4gIGxlbmd0aHM6IEZsb2F0MzJBcnJheTtcbiAgb2Zmc2V0czogRmxvYXQzMkFycmF5O1xufTtcbi8qKlxuICogUmVuZGVycyB0aGUgdGV4dCBsYWJlbHMgYXMgM2QgZ2VvbWV0cnkgaW4gdGhlIHdvcmxkLlxuICovXG5leHBvcnQgY2xhc3MgU2NhdHRlclBsb3RWaXN1YWxpemVyM0RMYWJlbHMgaW1wbGVtZW50cyBTY2F0dGVyUGxvdFZpc3VhbGl6ZXIge1xuICBwcml2YXRlIHNjZW5lOiBUSFJFRS5TY2VuZTtcbiAgcHJpdmF0ZSBsYWJlbFN0cmluZ3M6IHN0cmluZ1tdO1xuICBwcml2YXRlIGdlb21ldHJ5OiBUSFJFRS5CdWZmZXJHZW9tZXRyeTtcbiAgcHJpdmF0ZSB3b3JsZFNwYWNlUG9pbnRQb3NpdGlvbnM6IEZsb2F0MzJBcnJheTtcbiAgcHJpdmF0ZSBwaWNraW5nQ29sb3JzOiBGbG9hdDMyQXJyYXk7XG4gIHByaXZhdGUgcmVuZGVyQ29sb3JzOiBGbG9hdDMyQXJyYXk7XG4gIHByaXZhdGUgbWF0ZXJpYWw6IFRIUkVFLlNoYWRlck1hdGVyaWFsO1xuICBwcml2YXRlIHVuaWZvcm1zOiBhbnk7XG4gIHByaXZhdGUgbGFiZWxzTWVzaDogVEhSRUUuTWVzaDtcbiAgcHJpdmF0ZSBwb3NpdGlvbnM6IFRIUkVFLkJ1ZmZlckF0dHJpYnV0ZTtcbiAgcHJpdmF0ZSB0b3RhbFZlcnRleENvdW50OiBudW1iZXI7XG4gIHByaXZhdGUgbGFiZWxWZXJ0ZXhNYXA6IG51bWJlcltdW107XG4gIHByaXZhdGUgZ2x5cGhUZXh0dXJlOiBHbHlwaFRleHR1cmU7XG4gIHByaXZhdGUgY3JlYXRlR2x5cGhUZXh0dXJlKCk6IEdseXBoVGV4dHVyZSB7XG4gICAgbGV0IGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xuICAgIGNhbnZhcy53aWR0aCA9IE1BWF9DQU5WQVNfRElNRU5TSU9OO1xuICAgIGNhbnZhcy5oZWlnaHQgPSBGT05UX1NJWkU7XG4gICAgbGV0IGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpO1xuICAgIGN0eC5mb250ID0gJ2JvbGQgJyArIEZPTlRfU0laRSAqIDAuNzUgKyAncHggcm9ib3RvJztcbiAgICBjdHgudGV4dEJhc2VsaW5lID0gJ3RvcCc7XG4gICAgY3R4LmZpbGxTdHlsZSA9IExBQkVMX0JBQ0tHUk9VTkQ7XG4gICAgY3R4LnJlY3QoMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTtcbiAgICBjdHguZmlsbCgpO1xuICAgIGN0eC5maWxsU3R5bGUgPSBMQUJFTF9DT0xPUjtcbiAgICBsZXQgc3BhY2VPZmZzZXQgPSBjdHgubWVhc3VyZVRleHQoJyAnKS53aWR0aDtcbiAgICAvLyBGb3IgZWFjaCBsZXR0ZXIsIHN0b3JlIGxlbmd0aCwgcG9zaXRpb24gYXQgdGhlIGVuY29kZWQgaW5kZXguXG4gICAgbGV0IGdseXBoTGVuZ3RocyA9IG5ldyBGbG9hdDMyQXJyYXkoTlVNX0dMWVBIUyk7XG4gICAgbGV0IGdseXBoT2Zmc2V0ID0gbmV3IEZsb2F0MzJBcnJheShOVU1fR0xZUEhTKTtcbiAgICBsZXQgbGVmdENvb3JkID0gMDtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IE5VTV9HTFlQSFM7IGkrKykge1xuICAgICAgbGV0IHRleHQgPSAnICcgKyBTdHJpbmcuZnJvbUNoYXJDb2RlKGkpO1xuICAgICAgbGV0IHRleHRMZW5ndGggPSBjdHgubWVhc3VyZVRleHQodGV4dCkud2lkdGg7XG4gICAgICBnbHlwaExlbmd0aHNbaV0gPSB0ZXh0TGVuZ3RoIC0gc3BhY2VPZmZzZXQ7XG4gICAgICBnbHlwaE9mZnNldFtpXSA9IGxlZnRDb29yZDtcbiAgICAgIGN0eC5maWxsVGV4dCh0ZXh0LCBsZWZ0Q29vcmQgLSBzcGFjZU9mZnNldCwgMCk7XG4gICAgICBsZWZ0Q29vcmQgKz0gdGV4dExlbmd0aDtcbiAgICB9XG4gICAgY29uc3QgdGV4ID0gdXRpbC5jcmVhdGVUZXh0dXJlKGNhbnZhcyk7XG4gICAgcmV0dXJuIHt0ZXh0dXJlOiB0ZXgsIGxlbmd0aHM6IGdseXBoTGVuZ3Rocywgb2Zmc2V0czogZ2x5cGhPZmZzZXR9O1xuICB9XG4gIHByaXZhdGUgcHJvY2Vzc0xhYmVsVmVydHMocG9pbnRDb3VudDogbnVtYmVyKSB7XG4gICAgbGV0IG51bVRvdGFsTGV0dGVycyA9IDA7XG4gICAgdGhpcy5sYWJlbFZlcnRleE1hcCA9IFtdO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9pbnRDb3VudDsgaSsrKSB7XG4gICAgICBjb25zdCBsYWJlbCA9IHRoaXMubGFiZWxTdHJpbmdzW2ldO1xuICAgICAgbGV0IHZlcnRzQXJyYXk6IG51bWJlcltdID0gW107XG4gICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGxhYmVsLmxlbmd0aDsgaisrKSB7XG4gICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgVkVSVElDRVNfUEVSX0dMWVBIOyBrKyspIHtcbiAgICAgICAgICB2ZXJ0c0FycmF5LnB1c2gobnVtVG90YWxMZXR0ZXJzICogVkVSVElDRVNfUEVSX0dMWVBIICsgayk7XG4gICAgICAgIH1cbiAgICAgICAgbnVtVG90YWxMZXR0ZXJzKys7XG4gICAgICB9XG4gICAgICB0aGlzLmxhYmVsVmVydGV4TWFwLnB1c2godmVydHNBcnJheSk7XG4gICAgfVxuICAgIHRoaXMudG90YWxWZXJ0ZXhDb3VudCA9IG51bVRvdGFsTGV0dGVycyAqIFZFUlRJQ0VTX1BFUl9HTFlQSDtcbiAgfVxuICBwcml2YXRlIGNyZWF0ZUNvbG9yQnVmZmVycyhwb2ludENvdW50OiBudW1iZXIpIHtcbiAgICB0aGlzLnBpY2tpbmdDb2xvcnMgPSBuZXcgRmxvYXQzMkFycmF5KFxuICAgICAgdGhpcy50b3RhbFZlcnRleENvdW50ICogUkdCX0VMRU1FTlRTX1BFUl9FTlRSWVxuICAgICk7XG4gICAgdGhpcy5yZW5kZXJDb2xvcnMgPSBuZXcgRmxvYXQzMkFycmF5KFxuICAgICAgdGhpcy50b3RhbFZlcnRleENvdW50ICogUkdCX0VMRU1FTlRTX1BFUl9FTlRSWVxuICAgICk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb2ludENvdW50OyBpKyspIHtcbiAgICAgIGxldCBjb2xvciA9IG5ldyBUSFJFRS5Db2xvcihpKTtcbiAgICAgIHRoaXMubGFiZWxWZXJ0ZXhNYXBbaV0uZm9yRWFjaCgoaikgPT4ge1xuICAgICAgICB0aGlzLnBpY2tpbmdDb2xvcnNbUkdCX0VMRU1FTlRTX1BFUl9FTlRSWSAqIGpdID0gY29sb3IucjtcbiAgICAgICAgdGhpcy5waWNraW5nQ29sb3JzW1JHQl9FTEVNRU5UU19QRVJfRU5UUlkgKiBqICsgMV0gPSBjb2xvci5nO1xuICAgICAgICB0aGlzLnBpY2tpbmdDb2xvcnNbUkdCX0VMRU1FTlRTX1BFUl9FTlRSWSAqIGogKyAyXSA9IGNvbG9yLmI7XG4gICAgICAgIHRoaXMucmVuZGVyQ29sb3JzW1JHQl9FTEVNRU5UU19QRVJfRU5UUlkgKiBqXSA9IDE7XG4gICAgICAgIHRoaXMucmVuZGVyQ29sb3JzW1JHQl9FTEVNRU5UU19QRVJfRU5UUlkgKiBqICsgMV0gPSAxO1xuICAgICAgICB0aGlzLnJlbmRlckNvbG9yc1tSR0JfRUxFTUVOVFNfUEVSX0VOVFJZICogaiArIDJdID0gMTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuICBwcml2YXRlIGNyZWF0ZUxhYmVscygpIHtcbiAgICBpZiAodGhpcy5sYWJlbFN0cmluZ3MgPT0gbnVsbCB8fCB0aGlzLndvcmxkU3BhY2VQb2ludFBvc2l0aW9ucyA9PSBudWxsKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IHBvaW50Q291bnQgPVxuICAgICAgdGhpcy53b3JsZFNwYWNlUG9pbnRQb3NpdGlvbnMubGVuZ3RoIC8gWFlaX0VMRU1FTlRTX1BFUl9FTlRSWTtcbiAgICBpZiAocG9pbnRDb3VudCAhPT0gdGhpcy5sYWJlbFN0cmluZ3MubGVuZ3RoKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuZ2x5cGhUZXh0dXJlID0gdGhpcy5jcmVhdGVHbHlwaFRleHR1cmUoKTtcbiAgICB0aGlzLnVuaWZvcm1zID0ge1xuICAgICAgdGV4dHVyZToge3R5cGU6ICd0J30sXG4gICAgICBwaWNraW5nOiB7dHlwZTogJ2Jvb2wnfSxcbiAgICB9O1xuICAgIHRoaXMubWF0ZXJpYWwgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoe1xuICAgICAgdW5pZm9ybXM6IHRoaXMudW5pZm9ybXMsXG4gICAgICB0cmFuc3BhcmVudDogdHJ1ZSxcbiAgICAgIHZlcnRleFNoYWRlcjogVkVSVEVYX1NIQURFUixcbiAgICAgIGZyYWdtZW50U2hhZGVyOiBGUkFHTUVOVF9TSEFERVIsXG4gICAgfSk7XG4gICAgdGhpcy5wcm9jZXNzTGFiZWxWZXJ0cyhwb2ludENvdW50KTtcbiAgICB0aGlzLmNyZWF0ZUNvbG9yQnVmZmVycyhwb2ludENvdW50KTtcbiAgICBsZXQgcG9zaXRpb25BcnJheSA9IG5ldyBGbG9hdDMyQXJyYXkoXG4gICAgICB0aGlzLnRvdGFsVmVydGV4Q291bnQgKiBYWVpfRUxFTUVOVFNfUEVSX0VOVFJZXG4gICAgKTtcbiAgICB0aGlzLnBvc2l0aW9ucyA9IG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUoXG4gICAgICBwb3NpdGlvbkFycmF5LFxuICAgICAgWFlaX0VMRU1FTlRTX1BFUl9FTlRSWVxuICAgICk7XG4gICAgbGV0IHBvc0FycmF5ID0gbmV3IEZsb2F0MzJBcnJheShcbiAgICAgIHRoaXMudG90YWxWZXJ0ZXhDb3VudCAqIFhZWl9FTEVNRU5UU19QRVJfRU5UUllcbiAgICApO1xuICAgIGxldCB1dkFycmF5ID0gbmV3IEZsb2F0MzJBcnJheShcbiAgICAgIHRoaXMudG90YWxWZXJ0ZXhDb3VudCAqIFVWX0VMRU1FTlRTX1BFUl9FTlRSWVxuICAgICk7XG4gICAgbGV0IGNvbG9yc0FycmF5ID0gbmV3IEZsb2F0MzJBcnJheShcbiAgICAgIHRoaXMudG90YWxWZXJ0ZXhDb3VudCAqIFJHQl9FTEVNRU5UU19QRVJfRU5UUllcbiAgICApO1xuICAgIGxldCBwb3NpdGlvbk9iamVjdCA9IG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUocG9zQXJyYXksIDIpO1xuICAgIGxldCB1diA9IG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUodXZBcnJheSwgVVZfRUxFTUVOVFNfUEVSX0VOVFJZKTtcbiAgICBsZXQgY29sb3JzID0gbmV3IFRIUkVFLkJ1ZmZlckF0dHJpYnV0ZShjb2xvcnNBcnJheSwgUkdCX0VMRU1FTlRTX1BFUl9FTlRSWSk7XG4gICAgdGhpcy5nZW9tZXRyeSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpO1xuICAgIHRoaXMuZ2VvbWV0cnkuYWRkQXR0cmlidXRlKCdwb3NPYmonLCBwb3NpdGlvbk9iamVjdCk7XG4gICAgdGhpcy5nZW9tZXRyeS5hZGRBdHRyaWJ1dGUoJ3Bvc2l0aW9uJywgdGhpcy5wb3NpdGlvbnMpO1xuICAgIHRoaXMuZ2VvbWV0cnkuYWRkQXR0cmlidXRlKCd1dicsIHV2KTtcbiAgICB0aGlzLmdlb21ldHJ5LmFkZEF0dHJpYnV0ZSgnY29sb3InLCBjb2xvcnMpO1xuICAgIGxldCBsZXR0ZXJzU29GYXIgPSAwO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9pbnRDb3VudDsgaSsrKSB7XG4gICAgICBjb25zdCBsYWJlbCA9IHRoaXMubGFiZWxTdHJpbmdzW2ldO1xuICAgICAgbGV0IGxlZnRPZmZzZXQgPSAwO1xuICAgICAgLy8gRGV0ZXJtaW5lIGxlbmd0aCBvZiB3b3JkIGluIHBpeGVscy5cbiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgbGFiZWwubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgbGV0IGxldHRlckNvZGUgPSBsYWJlbC5jaGFyQ29kZUF0KGopO1xuICAgICAgICBsZWZ0T2Zmc2V0ICs9IHRoaXMuZ2x5cGhUZXh0dXJlLmxlbmd0aHNbbGV0dGVyQ29kZV07XG4gICAgICB9XG4gICAgICBsZWZ0T2Zmc2V0IC89IC0yOyAvLyBjZW50ZXJzIHRleHQgaG9yaXpvbnRhbGx5IGFyb3VuZCB0aGUgb3JpZ2luXG4gICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGxhYmVsLmxlbmd0aDsgaisrKSB7XG4gICAgICAgIGxldCBsZXR0ZXJDb2RlID0gbGFiZWwuY2hhckNvZGVBdChqKTtcbiAgICAgICAgbGV0IGxldHRlcldpZHRoID0gdGhpcy5nbHlwaFRleHR1cmUubGVuZ3Roc1tsZXR0ZXJDb2RlXTtcbiAgICAgICAgbGV0IHNjYWxlID0gRk9OVF9TSVpFO1xuICAgICAgICBsZXQgcmlnaHQgPSAobGVmdE9mZnNldCArIGxldHRlcldpZHRoKSAvIHNjYWxlO1xuICAgICAgICBsZXQgbGVmdCA9IGxlZnRPZmZzZXQgLyBzY2FsZTtcbiAgICAgICAgbGV0IHRvcCA9IEZPTlRfU0laRSAvIHNjYWxlO1xuICAgICAgICAvLyBGaXJzdCB0cmlhbmdsZVxuICAgICAgICBpZih3aW5kb3cudW5MYWJlbERhdGEuaW5kZXhPZihpKSAhPT0gLTEpe1xuICAgICAgICAgIHBvc2l0aW9uT2JqZWN0LnNldFhZKGxldHRlcnNTb0ZhciAqIFZFUlRJQ0VTX1BFUl9HTFlQSCArIDAsIGxlZnQsIDApO1xuICAgICAgICAgIHBvc2l0aW9uT2JqZWN0LnNldFhZKGxldHRlcnNTb0ZhciAqIFZFUlRJQ0VTX1BFUl9HTFlQSCArIDEsIHJpZ2h0LCAwKTtcbiAgICAgICAgICBwb3NpdGlvbk9iamVjdC5zZXRYWShsZXR0ZXJzU29GYXIgKiBWRVJUSUNFU19QRVJfR0xZUEggKyAyLCBsZWZ0LCB0b3ApO1xuICAgICAgICAgIC8vIFNlY29uZCB0cmlhbmdsZVxuICAgICAgICAgIHBvc2l0aW9uT2JqZWN0LnNldFhZKGxldHRlcnNTb0ZhciAqIFZFUlRJQ0VTX1BFUl9HTFlQSCArIDMsIGxlZnQsIHRvcCk7XG4gICAgICAgICAgcG9zaXRpb25PYmplY3Quc2V0WFkobGV0dGVyc1NvRmFyICogVkVSVElDRVNfUEVSX0dMWVBIICsgNCwgcmlnaHQsIDApO1xuICAgICAgICAgIHBvc2l0aW9uT2JqZWN0LnNldFhZKGxldHRlcnNTb0ZhciAqIFZFUlRJQ0VTX1BFUl9HTFlQSCArIDUsIHJpZ2h0LCB0b3ApO1xuICAgICAgICB9XG4gICAgIFxuICAgICAgICAvLyBTZXQgVVZzIGJhc2VkIG9uIGxldHRlci5cbiAgICAgICAgbGV0IHVMZWZ0ID0gdGhpcy5nbHlwaFRleHR1cmUub2Zmc2V0c1tsZXR0ZXJDb2RlXTtcbiAgICAgICAgbGV0IHVSaWdodCA9IHRoaXMuZ2x5cGhUZXh0dXJlLm9mZnNldHNbbGV0dGVyQ29kZV0gKyBsZXR0ZXJXaWR0aDtcbiAgICAgICAgLy8gU2NhbGUgc28gdGhhdCB1dnMgbGllIGJldHdlZW4gMCBhbmQgMSBvbiB0aGUgdGV4dHVyZS5cbiAgICAgICAgdUxlZnQgLz0gTUFYX0NBTlZBU19ESU1FTlNJT047XG4gICAgICAgIHVSaWdodCAvPSBNQVhfQ0FOVkFTX0RJTUVOU0lPTjtcbiAgICAgICAgbGV0IHZUb3AgPSAxO1xuICAgICAgICBsZXQgdkJvdHRvbSA9IDA7XG4gICAgICAgIHV2LnNldFhZKGxldHRlcnNTb0ZhciAqIFZFUlRJQ0VTX1BFUl9HTFlQSCArIDAsIHVMZWZ0LCB2VG9wKTtcbiAgICAgICAgdXYuc2V0WFkobGV0dGVyc1NvRmFyICogVkVSVElDRVNfUEVSX0dMWVBIICsgMSwgdVJpZ2h0LCB2VG9wKTtcbiAgICAgICAgdXYuc2V0WFkobGV0dGVyc1NvRmFyICogVkVSVElDRVNfUEVSX0dMWVBIICsgMiwgdUxlZnQsIHZCb3R0b20pO1xuICAgICAgICB1di5zZXRYWShsZXR0ZXJzU29GYXIgKiBWRVJUSUNFU19QRVJfR0xZUEggKyAzLCB1TGVmdCwgdkJvdHRvbSk7XG4gICAgICAgIHV2LnNldFhZKGxldHRlcnNTb0ZhciAqIFZFUlRJQ0VTX1BFUl9HTFlQSCArIDQsIHVSaWdodCwgdlRvcCk7XG4gICAgICAgIHV2LnNldFhZKGxldHRlcnNTb0ZhciAqIFZFUlRJQ0VTX1BFUl9HTFlQSCArIDUsIHVSaWdodCwgdkJvdHRvbSk7XG4gICAgICAgIGxldHRlcnNTb0ZhcisrO1xuICAgICAgICBsZWZ0T2Zmc2V0ICs9IGxldHRlcldpZHRoO1xuICAgICAgfVxuICAgIH1cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvaW50Q291bnQ7IGkrKykge1xuICAgICAgY29uc3QgcCA9IHV0aWwudmVjdG9yM0Zyb21QYWNrZWRBcnJheSh0aGlzLndvcmxkU3BhY2VQb2ludFBvc2l0aW9ucywgaSk7XG4gICAgICB0aGlzLmxhYmVsVmVydGV4TWFwW2ldLmZvckVhY2goKGopID0+IHtcbiAgICAgICAgdGhpcy5wb3NpdGlvbnMuc2V0WFlaKGosIHAueCwgcC55LCBwLnopO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHRoaXMubGFiZWxzTWVzaCA9IG5ldyBUSFJFRS5NZXNoKHRoaXMuZ2VvbWV0cnksIHRoaXMubWF0ZXJpYWwpO1xuICAgIHRoaXMubGFiZWxzTWVzaC5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7XG4gICAgdGhpcy5zY2VuZS5hZGQodGhpcy5sYWJlbHNNZXNoKTtcbiAgfVxuICBwcml2YXRlIGNvbG9yTGFiZWxzKHBvaW50Q29sb3JzOiBGbG9hdDMyQXJyYXkpIHtcbiAgICBpZiAoXG4gICAgICB0aGlzLmxhYmVsU3RyaW5ncyA9PSBudWxsIHx8XG4gICAgICB0aGlzLmdlb21ldHJ5ID09IG51bGwgfHxcbiAgICAgIHBvaW50Q29sb3JzID09IG51bGxcbiAgICApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgY29sb3JzID0gdGhpcy5nZW9tZXRyeS5nZXRBdHRyaWJ1dGUoJ2NvbG9yJykgYXMgVEhSRUUuQnVmZmVyQXR0cmlidXRlO1xuICAgIChjb2xvcnMgYXMgYW55KS5zZXRBcnJheSh0aGlzLnJlbmRlckNvbG9ycyk7XG4gICAgY29uc3QgbiA9IHBvaW50Q29sb3JzLmxlbmd0aCAvIFhZWl9FTEVNRU5UU19QRVJfRU5UUlk7XG4gICAgbGV0IHNyYyA9IDA7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBuOyArK2kpIHtcbiAgICAgIGNvbnN0IGMgPSBuZXcgVEhSRUUuQ29sb3IoXG4gICAgICAgIHBvaW50Q29sb3JzW3NyY10sXG4gICAgICAgIHBvaW50Q29sb3JzW3NyYyArIDFdLFxuICAgICAgICBwb2ludENvbG9yc1tzcmMgKyAyXVxuICAgICAgKTtcbiAgICAgIGNvbnN0IG0gPSB0aGlzLmxhYmVsVmVydGV4TWFwW2ldLmxlbmd0aDtcbiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgbTsgKytqKSB7XG4gICAgICAgIGNvbG9ycy5zZXRYWVoodGhpcy5sYWJlbFZlcnRleE1hcFtpXVtqXSwgYy5yLCBjLmcsIGMuYik7XG4gICAgICB9XG4gICAgICBzcmMgKz0gUkdCX0VMRU1FTlRTX1BFUl9FTlRSWTtcbiAgICB9XG4gICAgY29sb3JzLm5lZWRzVXBkYXRlID0gdHJ1ZTtcbiAgfVxuICBzZXRTY2VuZShzY2VuZTogVEhSRUUuU2NlbmUpIHtcbiAgICB0aGlzLnNjZW5lID0gc2NlbmU7XG4gIH1cbiAgZGlzcG9zZSgpIHtcbiAgICBpZiAodGhpcy5sYWJlbHNNZXNoKSB7XG4gICAgICBpZiAodGhpcy5zY2VuZSkge1xuICAgICAgICB0aGlzLnNjZW5lLnJlbW92ZSh0aGlzLmxhYmVsc01lc2gpO1xuICAgICAgfVxuICAgICAgdGhpcy5sYWJlbHNNZXNoID0gbnVsbDtcbiAgICB9XG4gICAgaWYgKHRoaXMuZ2VvbWV0cnkpIHtcbiAgICAgIHRoaXMuZ2VvbWV0cnkuZGlzcG9zZSgpO1xuICAgICAgdGhpcy5nZW9tZXRyeSA9IG51bGw7XG4gICAgfVxuICAgIGlmICh0aGlzLmdseXBoVGV4dHVyZSAhPSBudWxsICYmIHRoaXMuZ2x5cGhUZXh0dXJlLnRleHR1cmUgIT0gbnVsbCkge1xuICAgICAgdGhpcy5nbHlwaFRleHR1cmUudGV4dHVyZS5kaXNwb3NlKCk7XG4gICAgICB0aGlzLmdseXBoVGV4dHVyZS50ZXh0dXJlID0gbnVsbDtcbiAgICB9XG4gIH1cbiAgb25QaWNraW5nUmVuZGVyKHJjOiBSZW5kZXJDb250ZXh0KSB7XG4gICAgaWYgKHRoaXMuZ2VvbWV0cnkgPT0gbnVsbCkge1xuICAgICAgdGhpcy5jcmVhdGVMYWJlbHMoKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuZ2VvbWV0cnkgPT0gbnVsbCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLm1hdGVyaWFsLnVuaWZvcm1zLnRleHR1cmUudmFsdWUgPSB0aGlzLmdseXBoVGV4dHVyZS50ZXh0dXJlO1xuICAgIHRoaXMubWF0ZXJpYWwudW5pZm9ybXMucGlja2luZy52YWx1ZSA9IHRydWU7XG4gICAgY29uc3QgY29sb3JzID0gdGhpcy5nZW9tZXRyeS5nZXRBdHRyaWJ1dGUoJ2NvbG9yJykgYXMgVEhSRUUuQnVmZmVyQXR0cmlidXRlO1xuICAgIChjb2xvcnMgYXMgYW55KS5zZXRBcnJheSh0aGlzLnBpY2tpbmdDb2xvcnMpO1xuICAgIGNvbG9ycy5uZWVkc1VwZGF0ZSA9IHRydWU7XG4gIH1cbiAgb25SZW5kZXIocmM6IFJlbmRlckNvbnRleHQpIHtcbiAgICBpZiAodGhpcy5nZW9tZXRyeSA9PSBudWxsKSB7XG4gICAgICB0aGlzLmNyZWF0ZUxhYmVscygpO1xuICAgIH1cbiAgICBpZiAodGhpcy5nZW9tZXRyeSA9PSBudWxsKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuY29sb3JMYWJlbHMocmMucG9pbnRDb2xvcnMpO1xuICAgIHRoaXMubWF0ZXJpYWwudW5pZm9ybXMudGV4dHVyZS52YWx1ZSA9IHRoaXMuZ2x5cGhUZXh0dXJlLnRleHR1cmU7XG4gICAgdGhpcy5tYXRlcmlhbC51bmlmb3Jtcy5waWNraW5nLnZhbHVlID0gZmFsc2U7XG4gICAgY29uc3QgY29sb3JzID0gdGhpcy5nZW9tZXRyeS5nZXRBdHRyaWJ1dGUoJ2NvbG9yJykgYXMgVEhSRUUuQnVmZmVyQXR0cmlidXRlO1xuICAgIChjb2xvcnMgYXMgYW55KS5zZXRBcnJheSh0aGlzLnJlbmRlckNvbG9ycyk7XG4gICAgY29sb3JzLm5lZWRzVXBkYXRlID0gdHJ1ZTtcbiAgfVxuICBvblBvaW50UG9zaXRpb25zQ2hhbmdlZChuZXdQb3NpdGlvbnM6IEZsb2F0MzJBcnJheSkge1xuICAgIHRoaXMud29ybGRTcGFjZVBvaW50UG9zaXRpb25zID0gbmV3UG9zaXRpb25zO1xuICAgIHRoaXMuZGlzcG9zZSgpO1xuICB9XG4gIHNldExhYmVsU3RyaW5ncyhsYWJlbFN0cmluZ3M6IHN0cmluZ1tdKSB7XG4gICAgdGhpcy5sYWJlbFN0cmluZ3MgPSBsYWJlbFN0cmluZ3M7XG4gICAgdGhpcy5kaXNwb3NlKCk7XG4gIH1cbiAgb25SZXNpemUobmV3V2lkdGg6IG51bWJlciwgbmV3SGVpZ2h0OiBudW1iZXIpIHt9XG59XG4iXX0=