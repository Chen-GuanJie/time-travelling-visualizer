/* Copyright 2016 The TensorFlow Authors. All Rights Reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
==============================================================================*/
import * as THREE from 'three';
import * as util from './util';
const RGB_NUM_ELEMENTS = 3;
const XYZ_NUM_ELEMENTS = 3;
/**
 * Renders polylines that connect multiple points in the dataset.
 */
export class ScatterPlotVisualizerPolylines {
    constructor() {
        this.polylinePositionBuffer = {};
        this.polylineColorBuffer = {};
    }
    updateSequenceIndicesInDataSet(ds) {
        for (let i = 0; i < ds.sequences.length; i++) {
            const sequence = ds.sequences[i];
            for (let j = 0; j < sequence.pointIndices.length - 1; j++) {
                ds.points[sequence.pointIndices[j]].sequenceIndex = i;
                ds.points[sequence.pointIndices[j + 1]].sequenceIndex = i;
            }
        }
    }
    createPolylines(scene) {
        if (!this.dataSet || !this.dataSet.sequences) {
            return;
        }
        this.updateSequenceIndicesInDataSet(this.dataSet);
        this.polylines = [];
        for (let i = 0; i < this.dataSet.sequences.length; i++) {
            const geometry = new THREE.BufferGeometry();
            geometry.addAttribute('position', this.polylinePositionBuffer[i]);
            geometry.addAttribute('color', this.polylineColorBuffer[i]);
            const material = new THREE.LineBasicMaterial({
                linewidth: 1,
                opacity: 1.0,
                transparent: true,
                vertexColors: THREE.VertexColors,
            });
            const polyline = new THREE.LineSegments(geometry, material);
            polyline.frustumCulled = false;
            this.polylines.push(polyline);
            scene.add(polyline);
        }
    }
    dispose() {
        if (this.polylines == null) {
            return;
        }
        for (let i = 0; i < this.polylines.length; i++) {
            this.scene.remove(this.polylines[i]);
            this.polylines[i].geometry.dispose();
        }
        this.polylines = null;
        this.polylinePositionBuffer = {};
        this.polylineColorBuffer = {};
    }
    setScene(scene) {
        this.scene = scene;
    }
    setDataSet(dataSet) {
        this.dataSet = dataSet;
    }
    onPointPositionsChanged(newPositions) {
        if (newPositions == null || this.polylines != null) {
            this.dispose();
        }
        if (newPositions == null || this.dataSet == null) {
            return;
        }
        // Set up the position buffer arrays for each polyline.
        for (let i = 0; i < this.dataSet.sequences.length; i++) {
            let sequence = this.dataSet.sequences[i];
            const vertexCount = 2 * (sequence.pointIndices.length - 1);
            let polylines = new Float32Array(vertexCount * XYZ_NUM_ELEMENTS);
            this.polylinePositionBuffer[i] = new THREE.BufferAttribute(polylines, XYZ_NUM_ELEMENTS);
            let colors = new Float32Array(vertexCount * RGB_NUM_ELEMENTS);
            this.polylineColorBuffer[i] = new THREE.BufferAttribute(colors, RGB_NUM_ELEMENTS);
        }
        for (let i = 0; i < this.dataSet.sequences.length; i++) {
            const sequence = this.dataSet.sequences[i];
            let src = 0;
            for (let j = 0; j < sequence.pointIndices.length - 1; j++) {
                const p1Index = sequence.pointIndices[j];
                const p2Index = sequence.pointIndices[j + 1];
                const p1 = util.vector3FromPackedArray(newPositions, p1Index);
                const p2 = util.vector3FromPackedArray(newPositions, p2Index);
                this.polylinePositionBuffer[i].setXYZ(src, p1.x, p1.y, p1.z);
                this.polylinePositionBuffer[i].setXYZ(src + 1, p2.x, p2.y, p2.z);
                src += 2;
            }
            this.polylinePositionBuffer[i].needsUpdate = true;
        }
        if (this.polylines == null) {
            this.createPolylines(this.scene);
        }
    }
    onRender(renderContext) {
        if (this.polylines == null) {
            return;
        }
        for (let i = 0; i < this.polylines.length; i++) {
            const mat = this.polylines[i].material;
            mat.opacity = renderContext.polylineOpacities[i];
            mat.linewidth = renderContext.polylineWidths[i];
            this.polylineColorBuffer[i].setArray(renderContext.polylineColors[i]);
            this.polylineColorBuffer[i].needsUpdate = true;
        }
    }
    onPickingRender(renderContext) { }
    onResize(newWidth, newHeight) { }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NhdHRlclBsb3RWaXN1YWxpemVyUG9seWxpbmVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vdGVuc29yYm9hcmQvcHJvamVjdG9yL3NjYXR0ZXJQbG90VmlzdWFsaXplclBvbHlsaW5lcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7OztnRkFhZ0Y7QUFDaEYsT0FBTyxLQUFLLEtBQUssTUFBTSxPQUFPLENBQUM7QUFLL0IsT0FBTyxLQUFLLElBQUksTUFBTSxRQUFRLENBQUM7QUFFL0IsTUFBTSxnQkFBZ0IsR0FBRyxDQUFDLENBQUM7QUFDM0IsTUFBTSxnQkFBZ0IsR0FBRyxDQUFDLENBQUM7QUFDM0I7O0dBRUc7QUFDSCxNQUFNLE9BQU8sOEJBQThCO0lBQTNDO1FBSVUsMkJBQXNCLEdBRTFCLEVBQUUsQ0FBQztRQUNDLHdCQUFtQixHQUV2QixFQUFFLENBQUM7SUEwR1QsQ0FBQztJQXpHUyw4QkFBOEIsQ0FBQyxFQUFXO1FBQ2hELEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUM1QyxNQUFNLFFBQVEsR0FBRyxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2pDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxRQUFRLENBQUMsWUFBWSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7Z0JBQ3pELEVBQUUsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLGFBQWEsR0FBRyxDQUFDLENBQUM7Z0JBQ3RELEVBQUUsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLEdBQUcsQ0FBQyxD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R0FBRyxhQUFhLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQy9DLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLENBQVMsQ0FBQyxRQUFRLENBQzNDLGFBQWEsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQ2hDLENBQUM7WUFDRixJQUFJLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztTQUNoRDtJQUNILENBQUM7SUFDRCxlQUFlLENBQUMsYUFBNEIsSUFBRyxDQUFDO0lBQ2hELFFBQVEsQ0FBQyxRQUFnQixFQUFFLFNBQWlCLElBQUcsQ0FBQztDQUNqRCIsInNvdXJjZXNDb250ZW50IjpbIi8qIENvcHlyaWdodCAyMDE2IFRoZSBUZW5zb3JGbG93IEF1dGhvcnMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG5cbkxpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG55b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG5Zb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcblxuICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuXG5Vbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG5kaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG5XSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cblNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbmxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbmltcG9ydCAqIGFzIFRIUkVFIGZyb20gJ3RocmVlJztcblxuaW1wb3J0IHtEYXRhU2V0fSBmcm9tICcuL2RhdGEnO1xuaW1wb3J0IHtSZW5kZXJDb250ZXh0fSBmcm9tICcuL3JlbmRlckNvbnRleHQnO1xuaW1wb3J0IHtTY2F0dGVyUGxvdFZpc3VhbGl6ZXJ9IGZyb20gJy4vc2NhdHRlclBsb3RWaXN1YWxpemVyJztcbmltcG9ydCAqIGFzIHV0aWwgZnJvbSAnLi91dGlsJztcblxuY29uc3QgUkdCX05VTV9FTEVNRU5UUyA9IDM7XG5jb25zdCBYWVpfTlVNX0VMRU1FTlRTID0gMztcbi8qKlxuICogUmVuZGVycyBwb2x5bGluZXMgdGhhdCBjb25uZWN0IG11bHRpcGxlIHBvaW50cyBpbiB0aGUgZGF0YXNldC5cbiAqL1xuZXhwb3J0IGNsYXNzIFNjYXR0ZXJQbG90VmlzdWFsaXplclBvbHlsaW5lcyBpbXBsZW1lbnRzIFNjYXR0ZXJQbG90VmlzdWFsaXplciB7XG4gIHByaXZhdGUgZGF0YVNldDogRGF0YVNldDtcbiAgcHJpdmF0ZSBzY2VuZTogVEhSRUUuU2NlbmU7XG4gIHByaXZhdGUgcG9seWxpbmVzOiBUSFJFRS5MaW5lW107XG4gIHByaXZhdGUgcG9seWxpbmVQb3NpdGlvbkJ1ZmZlcjoge1xuICAgIFtwb2x5bGluZUluZGV4OiBudW1iZXJdOiBUSFJFRS5CdWZmZXJBdHRyaWJ1dGU7XG4gIH0gPSB7fTtcbiAgcHJpdmF0ZSBwb2x5bGluZUNvbG9yQnVmZmVyOiB7XG4gICAgW3BvbHlsaW5lSW5kZXg6IG51bWJlcl06IFRIUkVFLkJ1ZmZlckF0dHJpYnV0ZTtcbiAgfSA9IHt9O1xuICBwcml2YXRlIHVwZGF0ZVNlcXVlbmNlSW5kaWNlc0luRGF0YVNldChkczogRGF0YVNldCkge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZHMuc2VxdWVuY2VzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBzZXF1ZW5jZSA9IGRzLnNlcXVlbmNlc1tpXTtcbiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgc2VxdWVuY2UucG9pbnRJbmRpY2VzLmxlbmd0aCAtIDE7IGorKykge1xuICAgICAgICBkcy5wb2ludHNbc2VxdWVuY2UucG9pbnRJbmRpY2VzW2pdXS5zZXF1ZW5jZUluZGV4ID0gaTtcbiAgICAgICAgZHMucG9pbnRzW3NlcXVlbmNlLnBvaW50SW5kaWNlc1tqICsgMV1dLnNlcXVlbmNlSW5kZXggPSBpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBwcml2YXRlIGNyZWF0ZVBvbHlsaW5lcyhzY2VuZTogVEhSRUUuU2NlbmUpIHtcbiAgICBpZiAoIXRoaXMuZGF0YVNldCB8fCAhdGhpcy5kYXRhU2V0LnNlcXVlbmNlcykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLnVwZGF0ZVNlcXVlbmNlSW5kaWNlc0luRGF0YVNldCh0aGlzLmRhdGFTZXQpO1xuICAgIHRoaXMucG9seWxpbmVzID0gW107XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmRhdGFTZXQuc2VxdWVuY2VzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5CdWZmZXJHZW9tZXRyeSgpO1xuICAgICAgZ2VvbWV0cnkuYWRkQXR0cmlidXRlKCdwb3NpdGlvbicsIHRoaXMucG9seWxpbmVQb3NpdGlvbkJ1ZmZlcltpXSk7XG4gICAgICBnZW9tZXRyeS5hZGRBdHRyaWJ1dGUoJ2NvbG9yJywgdGhpcy5wb2x5bGluZUNvbG9yQnVmZmVyW2ldKTtcbiAgICAgIGNvbnN0IG1hdGVyaWFsID0gbmV3IFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsKHtcbiAgICAgICAgbGluZXdpZHRoOiAxLCAvLyB1bnVzZWQgZGVmYXVsdCwgb3ZlcndyaXR0ZW4gYnkgd2lkdGggYXJyYXkuXG4gICAgICAgIG9wYWNpdHk6IDEuMCwgLy8gdW51c2VkIGRlZmF1bHQsIG92ZXJ3cml0dGVuIGJ5IG9wYWNpdHkgYXJyYXkuXG4gICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLFxuICAgICAgICB2ZXJ0ZXhDb2xvcnM6IFRIUkVFLlZlcnRleENvbG9ycyBhcyBhbnksXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IHBvbHlsaW5lID0gbmV3IFRIUkVFLkxpbmVTZWdtZW50cyhnZW9tZXRyeSwgbWF0ZXJpYWwpO1xuICAgICAgcG9seWxpbmUuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlO1xuICAgICAgdGhpcy5wb2x5bGluZXMucHVzaChwb2x5bGluZSk7XG4gICAgICBzY2VuZS5hZGQocG9seWxpbmUpO1xuICAgIH1cbiAgfVxuICBkaXNwb3NlKCkge1xuICAgIGlmICh0aGlzLnBvbHlsaW5lcyA9PSBudWxsKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5wb2x5bGluZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIHRoaXMuc2NlbmUucmVtb3ZlKHRoaXMucG9seWxpbmVzW2ldKTtcbiAgICAgIHRoaXMucG9seWxpbmVzW2ldLmdlb21ldHJ5LmRpc3Bvc2UoKTtcbiAgICB9XG4gICAgdGhpcy5wb2x5bGluZXMgPSBudWxsO1xuICAgIHRoaXMucG9seWxpbmVQb3NpdGlvbkJ1ZmZlciA9IHt9O1xuICAgIHRoaXMucG9seWxpbmVDb2xvckJ1ZmZlciA9IHt9O1xuICB9XG4gIHNldFNjZW5lKHNjZW5lOiBUSFJFRS5TY2VuZSkge1xuICAgIHRoaXMuc2NlbmUgPSBzY2VuZTtcbiAgfVxuICBzZXREYXRhU2V0KGRhdGFTZXQ6IERhdGFTZXQpIHtcbiAgICB0aGlzLmRhdGFTZXQgPSBkYXRhU2V0O1xuICB9XG4gIG9uUG9pbnRQb3NpdGlvbnNDaGFuZ2VkKG5ld1Bvc2l0aW9uczogRmxvYXQzMkFycmF5KSB7XG4gICAgaWYgKG5ld1Bvc2l0aW9ucyA9PSBudWxsIHx8IHRoaXMucG9seWxpbmVzICE9IG51bGwpIHtcbiAgICAgIHRoaXMuZGlzcG9zZSgpO1xuICAgIH1cbiAgICBpZiAobmV3UG9zaXRpb25zID09IG51bGwgfHwgdGhpcy5kYXRhU2V0ID09IG51bGwpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgLy8gU2V0IHVwIHRoZSBwb3NpdGlvbiBidWZmZXIgYXJyYXlzIGZvciBlYWNoIHBvbHlsaW5lLlxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5kYXRhU2V0LnNlcXVlbmNlcy5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IHNlcXVlbmNlID0gdGhpcy5kYXRhU2V0LnNlcXVlbmNlc1tpXTtcbiAgICAgIGNvbnN0IHZlcnRleENvdW50ID0gMiAqIChzZXF1ZW5jZS5wb2ludEluZGljZXMubGVuZ3RoIC0gMSk7XG4gICAgICBsZXQgcG9seWxpbmVzID0gbmV3IEZsb2F0MzJBcnJheSh2ZXJ0ZXhDb3VudCAqIFhZWl9OVU1fRUxFTUVOVFMpO1xuICAgICAgdGhpcy5wb2x5bGluZVBvc2l0aW9uQnVmZmVyW2ldID0gbmV3IFRIUkVFLkJ1ZmZlckF0dHJpYnV0ZShcbiAgICAgICAgcG9seWxpbmVzLFxuICAgICAgICBYWVpfTlVNX0VMRU1FTlRTXG4gICAgICApO1xuICAgICAgbGV0IGNvbG9ycyA9IG5ldyBGbG9hdDMyQXJyYXkodmVydGV4Q291bnQgKiBSR0JfTlVNX0VMRU1FTlRTKTtcbiAgICAgIHRoaXMucG9seWxpbmVDb2xvckJ1ZmZlcltpXSA9IG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUoXG4gICAgICAgIGNvbG9ycyxcbiAgICAgICAgUkdCX05VTV9FTEVNRU5UU1xuICAgICAgKTtcbiAgICB9XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmRhdGFTZXQuc2VxdWVuY2VzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBzZXF1ZW5jZSA9IHRoaXMuZGF0YVNldC5zZXF1ZW5jZXNbaV07XG4gICAgICBsZXQgc3JjID0gMDtcbiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgc2VxdWVuY2UucG9pbnRJbmRpY2VzLmxlbmd0aCAtIDE7IGorKykge1xuICAgICAgICBjb25zdCBwMUluZGV4ID0gc2VxdWVuY2UucG9pbnRJbmRpY2VzW2pdO1xuICAgICAgICBjb25zdCBwMkluZGV4ID0gc2VxdWVuY2UucG9pbnRJbmRpY2VzW2ogKyAxXTtcbiAgICAgICAgY29uc3QgcDEgPSB1dGlsLnZlY3RvcjNGcm9tUGFja2VkQXJyYXkobmV3UG9zaXRpb25zLCBwMUluZGV4KTtcbiAgICAgICAgY29uc3QgcDIgPSB1dGlsLnZlY3RvcjNGcm9tUGFja2VkQXJyYXkobmV3UG9zaXRpb25zLCBwMkluZGV4KTtcbiAgICAgICAgdGhpcy5wb2x5bGluZVBvc2l0aW9uQnVmZmVyW2ldLnNldFhZWihzcmMsIHAxLngsIHAxLnksIHAxLnopO1xuICAgICAgICB0aGlzLnBvbHlsaW5lUG9zaXRpb25CdWZmZXJbaV0uc2V0WFlaKHNyYyArIDEsIHAyLngsIHAyLnksIHAyLnopO1xuICAgICAgICBzcmMgKz0gMjtcbiAgICAgIH1cbiAgICAgIHRoaXMucG9seWxpbmVQb3NpdGlvbkJ1ZmZlcltpXS5uZWVkc1VwZGF0ZSA9IHRydWU7XG4gICAgfVxuICAgIGlmICh0aGlzLnBvbHlsaW5lcyA9PSBudWxsKSB7XG4gICAgICB0aGlzLmNyZWF0ZVBvbHlsaW5lcyh0aGlzLnNjZW5lKTtcbiAgICB9XG4gIH1cbiAgb25SZW5kZXIocmVuZGVyQ29udGV4dDogUmVuZGVyQ29udGV4dCkge1xuICAgIGlmICh0aGlzLnBvbHlsaW5lcyA9PSBudWxsKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5wb2x5bGluZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IG1hdCA9IHRoaXMucG9seWxpbmVzW2ldLm1hdGVyaWFsIGFzIFRIUkVFLkxpbmVCYXNpY01hdGVyaWFsO1xuICAgICAgbWF0Lm9wYWNpdHkgPSByZW5kZXJDb250ZXh0LnBvbHlsaW5lT3BhY2l0aWVzW2ldO1xuICAgICAgbWF0LmxpbmV3aWR0aCA9IHJlbmRlckNvbnRleHQucG9seWxpbmVXaWR0aHNbaV07XG4gICAgICAodGhpcy5wb2x5bGluZUNvbG9yQnVmZmVyW2ldIGFzIGFueSkuc2V0QXJyYXkoXG4gICAgICAgIHJlbmRlckNvbnRleHQucG9seWxpbmVDb2xvcnNbaV1cbiAgICAgICk7XG4gICAgICB0aGlzLnBvbHlsaW5lQ29sb3JCdWZmZXJbaV0ubmVlZHNVcGRhdGUgPSB0cnVlO1xuICAgIH1cbiAgfVxuICBvblBpY2tpbmdSZW5kZXIocmVuZGVyQ29udGV4dDogUmVuZGVyQ29udGV4dCkge31cbiAgb25SZXNpemUobmV3V2lkdGg6IG51bWJlciwgbmV3SGVpZ2h0OiBudW1iZXIpIHt9XG59XG4iXX0=