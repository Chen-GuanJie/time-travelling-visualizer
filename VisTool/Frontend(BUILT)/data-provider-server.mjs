import { retrieveSpriteAndMetadataInfo, retrieveTensorAsBytes, } from './data-provider';
import * as logging from './logging';
// Limit for the number of data points we receive from the server.
export const LIMIT_NUM_POINTS = 100000;
/**
 * Data provider that loads data provided by a python server (usually backed
 * by a checkpoint file).
 */
export class ServerDataProvider {
    constructor(routePrefix) {
        this.runProjectorConfigCache = {};
        this.routePrefix = routePrefix;
    }
    getEmbeddingInfo(run, tensorName, callback) {
        this.retrieveProjectorConfig(run, (config) => {
            const embeddings = config.embeddings;
            for (let i = 0; i < embeddings.length; i++) {
                const embedding = embeddings[i];
                if (embedding.tensorName === tensorName) {
                    callback(embedding);
                    return;
                }
            }
            callback(null);
        });
    }
    retrieveRuns(callback) {
        const msgId = logging.setModalMessage('Fetching runs...');
        const xhr = new XMLHttpRequest();
        xhr.open('GET', `${this.routePrefix}/runs`);
        xhr.onerror = (err) => {
            logging.setErrorMessage(xhr.responseText, 'fetching runs');
        };
        xhr.onload = () => {
            const runs = JSON.parse(xhr.responseText);
            logging.setModalMessage(null, msgId);
            callback(runs);
        };
        xhr.send();
    }
    retrieveProjectorConfig(run, callback) {
        if (run in this.runProjectorConfigCache) {
            callback(this.runProjectorConfigCache[run]);
            return;
        }
        const msgId = logging.setModalMessage('Fetching projector config...');
        const xhr = new XMLHttpRequest();
        xhr.open('GET', `${this.routePrefix}/info?run=${run}`);
        xhr.onerror = (err) => {
            logging.setErrorMessage(xhr.responseText, 'fetching projector config');
        };
        xhr.onload = () => {
            const config = JSON.parse(xhr.responseText);
            logging.setModalMessage(null, msgId);
            this.runProjectorConfigCache[run] = config;
            callback(config);
        };
        xhr.send();
    }
    retrieveTensor(run, tensorName, callback) {
        this.getEmbeddingInfo(run, tensorName, (embedding) => {
            retrieveTensorAsBytes(this, embedding, run, tensorName, `${this.routePrefix}/tensor?run=${run}&name=${tensorName}` +
                `&num_rows=${LIMIT_NUM_POINTS}`, callback);
        });
    }
    retrieveSpriteAndMetadata(run, tensorName, callback) {
        this.getEmbeddingInfo(run, tensorName, (embedding) => {
            let metadataPath = null;
            if (embedding.metadataPath) {
                metadataPath =
                    `${this.routePrefix}/metadata?` +
                        `run=${run}&name=${tensorName}&num_rows=${LIMIT_NUM_POINTS}`;
            }
            let spriteImagePath = null;
            if (embedding.sprite && embedding.sprite.imagePath) {
                spriteImagePath = `${this.routePrefix}/sprite_image?run=${run}&name=${tensorName}`;
            }
            retrieveSpriteAndMetadataInfo(metadataPath, spriteImagePath, embedding.sprite, callback);
        });
    }
    getBookmarks(run, tensorName, callback) {
        const msgId = logging.setModalMessage('Fetching bookmarks...');
        const xhr = new XMLHttpRequest();
        xhr.open('GET', `${this.routePrefix}/bookmarks?run=${run}&name=${tensorName}`);
        xhr.onerror = (err) => {
            logging.setErrorMessage(xhr.responseText, 'fetching bookmarks');
        };
        xhr.onload = () => {
            logging.setModalMessage(null, msgId);
            const bookmarks = JSON.parse(xhr.responseText);
            callback(bookmarks);
        };
        xhr.send();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1wcm92aWRlci1zZXJ2ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi90ZW5zb3Jib2FyZC9wcm9qZWN0b3IvZGF0YS1wcm92aWRlci1zZXJ2ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBZUEsT0FBTyxFQUNMLDZCQUE2QixFQUM3QixxQkFBcUIsR0FJdEIsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QixPQUFPLEtBQUssT0FBTyxNQUFNLFdBQVcsQ0FBQztBQUVyQyxrRUFBa0U7QUFDbEUsTUFBTSxDQUFDLE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxDQUFDO0FBRXZDOzs7R0FHRztBQUNILE1BQU0sT0FBTyxrQkFBa0I7SUFLN0IsWUFBWSxXQUFtQjtRQUh2Qiw0QkFBdUIsR0FFM0IsRUFBRSxDQUFDO1FBRUwsSUFBSSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7SUFDakMsQ0FBQztJQUNPLGdCQUFnQixDQUN0QixHQUFXLEVBQ1gsVUFBa0IsRUFDbEIsUUFBb0M7UUFFcEMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLEdBQUcsRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFO1lBQzNDLE1BQU0sVUFBVSxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUM7WUFDckMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFVBQVUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7Z0JBQzFDLE1BQU0sU0FBUyxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDaEMsSUFBSSxTQUFTLENBQUMsVUFBVSxLQUFLLFVBQVUsRUFBRTtvQkFDdkMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO29CQUNwQixPQUFPO2lCQUNSO2FBQ0Y7WUFDRCxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDakIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ0QsWUFBWSxDQUFDLFFBQWtDO1FBQzdDLE1BQU0s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QztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiLyogQ29weXJpZ2h0IDIwMTYgVGhlIFRlbnNvckZsb3cgQXV0aG9ycy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cblxuTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbnlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbllvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuXG4gICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG5cblVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbmRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbldJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxubGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG49PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuaW1wb3J0IHtEYXRhU2V0LCBTdGF0ZSwgU3ByaXRlQW5kTWV0YWRhdGFJbmZvfSBmcm9tICcuL2RhdGEnO1xuaW1wb3J0IHtcbiAgcmV0cmlldmVTcHJpdGVBbmRNZXRhZGF0YUluZm8sXG4gIHJldHJpZXZlVGVuc29yQXNCeXRlcyxcbiAgRW1iZWRkaW5nSW5mbyxcbiAgRGF0YVByb3ZpZGVyLFxuICBQcm9qZWN0b3JDb25maWcsXG59IGZyb20gJy4vZGF0YS1wcm92aWRlcic7XG5pbXBvcnQgKiBhcyBsb2dnaW5nIGZyb20gJy4vbG9nZ2luZyc7XG5cbi8vIExpbWl0IGZvciB0aGUgbnVtYmVyIG9mIGRhdGEgcG9pbnRzIHdlIHJlY2VpdmUgZnJvbSB0aGUgc2VydmVyLlxuZXhwb3J0IGNvbnN0IExJTUlUX05VTV9QT0lOVFMgPSAxMDAwMDA7XG5cbi8qKlxuICogRGF0YSBwcm92aWRlciB0aGF0IGxvYWRzIGRhdGEgcHJvdmlkZWQgYnkgYSBweXRob24gc2VydmVyICh1c3VhbGx5IGJhY2tlZFxuICogYnkgYSBjaGVja3BvaW50IGZpbGUpLlxuICovXG5leHBvcnQgY2xhc3MgU2VydmVyRGF0YVByb3ZpZGVyIGltcGxlbWVudHMgRGF0YVByb3ZpZGVyIHtcbiAgcHJpdmF0ZSByb3V0ZVByZWZpeDogc3RyaW5nO1xuICBwcml2YXRlIHJ1blByb2plY3RvckNvbmZpZ0NhY2hlOiB7XG4gICAgW3J1bjogc3RyaW5nXTogUHJvamVjdG9yQ29uZmlnO1xuICB9ID0ge307XG4gIGNvbnN0cnVjdG9yKHJvdXRlUHJlZml4OiBzdHJpbmcpIHtcbiAgICB0aGlzLnJvdXRlUHJlZml4ID0gcm91dGVQcmVmaXg7XG4gIH1cbiAgcHJpdmF0ZSBnZXRFbWJlZGRpbmdJbmZvKFxuICAgIHJ1bjogc3RyaW5nLFxuICAgIHRlbnNvck5hbWU6IHN0cmluZyxcbiAgICBjYWxsYmFjazogKGU6IEVtYmVkZGluZ0luZm8pID0+IHZvaWRcbiAgKTogdm9pZCB7XG4gICAgdGhpcy5yZXRyaWV2ZVByb2plY3RvckNvbmZpZyhydW4sIChjb25maWcpID0+IHtcbiAgICAgIGNvbnN0IGVtYmVkZGluZ3MgPSBjb25maWcuZW1iZWRkaW5ncztcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZW1iZWRkaW5ncy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBlbWJlZGRpbmcgPSBlbWJlZGRpbmdzW2ldO1xuICAgICAgICBpZiAoZW1iZWRkaW5nLnRlbnNvck5hbWUgPT09IHRlbnNvck5hbWUpIHtcbiAgICAgICAgICBjYWxsYmFjayhlbWJlZGRpbmcpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY2FsbGJhY2sobnVsbCk7XG4gICAgfSk7XG4gIH1cbiAgcmV0cmlldmVSdW5zKGNhbGxiYWNrOiAocnVuczogc3RyaW5nW10pID0+IHZvaWQpOiB2b2lkIHtcbiAgICBjb25zdCBtc2dJZCA9IGxvZ2dpbmcuc2V0TW9kYWxNZXNzYWdlKCdGZXRjaGluZyBydW5zLi4uJyk7XG4gICAgY29uc3QgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG4gICAgeGhyLm9wZW4oJ0dFVCcsIGAke3RoaXMucm91dGVQcmVmaXh9L3J1bnNgKTtcbiAgICB4aHIub25lcnJvciA9IChlcnIpID0+IHtcbiAgICAgIGxvZ2dpbmcuc2V0RXJyb3JNZXNzYWdlKHhoci5yZXNwb25zZVRleHQsICdmZXRjaGluZyBydW5zJyk7XG4gICAgfTtcbiAgICB4aHIub25sb2FkID0gKCkgPT4ge1xuICAgICAgY29uc3QgcnVucyA9IEpTT04ucGFyc2UoeGhyLnJlc3BvbnNlVGV4dCk7XG4gICAgICBsb2dnaW5nLnNldE1vZGFsTWVzc2FnZShudWxsLCBtc2dJZCk7XG4gICAgICBjYWxsYmFjayhydW5zKTtcbiAgICB9O1xuICAgIHhoci5zZW5kKCk7XG4gIH1cbiAgcmV0cmlldmVQcm9qZWN0b3JDb25maWcoXG4gICAgcnVuOiBzdHJpbmcsXG4gICAgY2FsbGJhY2s6IChkOiBQcm9qZWN0b3JDb25maWcpID0+IHZvaWRcbiAgKTogdm9pZCB7XG4gICAgaWYgKHJ1biBpbiB0aGlzLnJ1blByb2plY3RvckNvbmZpZ0NhY2hlKSB7XG4gICAgICBjYWxsYmFjayh0aGlzLnJ1blByb2plY3RvckNvbmZpZ0NhY2hlW3J1bl0pO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBtc2dJZCA9IGxvZ2dpbmcuc2V0TW9kYWxNZXNzYWdlKCdGZXRjaGluZyBwcm9qZWN0b3IgY29uZmlnLi4uJyk7XG4gICAgY29uc3QgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG4gICAgeGhyLm9wZW4oJ0dFVCcsIGAke3RoaXMucm91dGVQcmVmaXh9L2luZm8/cnVuPSR7cnVufWApO1xuICAgIHhoci5vbmVycm9yID0gKGVycikgPT4ge1xuICAgICAgbG9nZ2luZy5zZXRFcnJvck1lc3NhZ2UoeGhyLnJlc3BvbnNlVGV4dCwgJ2ZldGNoaW5nIHByb2plY3RvciBjb25maWcnKTtcbiAgICB9O1xuICAgIHhoci5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICBjb25zdCBjb25maWcgPSBKU09OLnBhcnNlKHhoci5yZXNwb25zZVRleHQpIGFzIFByb2plY3RvckNvbmZpZztcbiAgICAgIGxvZ2dpbmcuc2V0TW9kYWxNZXNzYWdlKG51bGwsIG1zZ0lkKTtcbiAgICAgIHRoaXMucnVuUHJvamVjdG9yQ29uZmlnQ2FjaGVbcnVuXSA9IGNvbmZpZztcbiAgICAgIGNhbGxiYWNrKGNvbmZpZyk7XG4gICAgfTtcbiAgICB4aHIuc2VuZCgpO1xuICB9XG4gIHJldHJpZXZlVGVuc29yKFxuICAgIHJ1bjogc3RyaW5nLFxuICAgIHRlbnNvck5hbWU6IHN0cmluZyxcbiAgICBjYWxsYmFjazogKGRzOiBEYXRhU2V0KSA9PiB2b2lkXG4gICkge1xuICAgIHRoaXMuZ2V0RW1iZWRkaW5nSW5mbyhydW4sIHRlbnNvck5hbWUsIChlbWJlZGRpbmcpID0+IHtcbiAgICAgIHJldHJpZXZlVGVuc29yQXNCeXRlcyhcbiAgICAgICAgdGhpcyxcbiAgICAgICAgZW1iZWRkaW5nLFxuICAgICAgICBydW4sXG4gICAgICAgIHRlbnNvck5hbWUsXG4gICAgICAgIGAke3RoaXMucm91dGVQcmVmaXh9L3RlbnNvcj9ydW49JHtydW59Jm5hbWU9JHt0ZW5zb3JOYW1lfWAgK1xuICAgICAgICAgIGAmbnVtX3Jvd3M9JHtMSU1JVF9OVU1fUE9JTlRTfWAsXG4gICAgICAgIGNhbGxiYWNrXG4gICAgICApO1xuICAgIH0pO1xuICB9XG4gIHJldHJpZXZlU3ByaXRlQW5kTWV0YWRhdGEoXG4gICAgcnVuOiBzdHJpbmcsXG4gICAgdGVuc29yTmFtZTogc3RyaW5nLFxuICAgIGNhbGxiYWNrOiAocjogU3ByaXRlQW5kTWV0YWRhdGFJbmZvKSA9PiB2b2lkXG4gICkge1xuICAgIHRoaXMuZ2V0RW1iZWRkaW5nSW5mbyhydW4sIHRlbnNvck5hbWUsIChlbWJlZGRpbmcpID0+IHtcbiAgICAgIGxldCBtZXRhZGF0YVBhdGggPSBudWxsO1xuICAgICAgaWYgKGVtYmVkZGluZy5tZXRhZGF0YVBhdGgpIHtcbiAgICAgICAgbWV0YWRhdGFQYXRoID1cbiAgICAgICAgICBgJHt0aGlzLnJvdXRlUHJlZml4fS9tZXRhZGF0YT9gICtcbiAgICAgICAgICBgcnVuPSR7cnVufSZuYW1lPSR7dGVuc29yTmFtZX0mbnVtX3Jvd3M9JHtMSU1JVF9OVU1fUE9JTlRTfWA7XG4gICAgICB9XG4gICAgICBsZXQgc3ByaXRlSW1hZ2VQYXRoID0gbnVsbDtcbiAgICAgIGlmIChlbWJlZGRpbmcuc3ByaXRlICYmIGVtYmVkZGluZy5zcHJpdGUuaW1hZ2VQYXRoKSB7XG4gICAgICAgIHNwcml0ZUltYWdlUGF0aCA9IGAke3RoaXMucm91dGVQcmVmaXh9L3Nwcml0ZV9pbWFnZT9ydW49JHtydW59Jm5hbWU9JHt0ZW5zb3JOYW1lfWA7XG4gICAgICB9XG4gICAgICByZXRyaWV2ZVNwcml0ZUFuZE1ldGFkYXRhSW5mbyhcbiAgICAgICAgbWV0YWRhdGFQYXRoLFxuICAgICAgICBzcHJpdGVJbWFnZVBhdGgsXG4gICAgICAgIGVtYmVkZGluZy5zcHJpdGUsXG4gICAgICAgIGNhbGxiYWNrXG4gICAgICApO1xuICAgIH0pO1xuICB9XG4gIGdldEJvb2ttYXJrcyhcbiAgICBydW46IHN0cmluZyxcbiAgICB0ZW5zb3JOYW1lOiBzdHJpbmcsXG4gICAgY2FsbGJhY2s6IChyOiBTdGF0ZVtdKSA9PiB2b2lkXG4gICkge1xuICAgIGNvbnN0IG1zZ0lkID0gbG9nZ2luZy5zZXRNb2RhbE1lc3NhZ2UoJ0ZldGNoaW5nIGJvb2ttYXJrcy4uLicpO1xuICAgIGNvbnN0IHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgIHhoci5vcGVuKFxuICAgICAgJ0dFVCcsXG4gICAgICBgJHt0aGlzLnJvdXRlUHJlZml4fS9ib29rbWFya3M/cnVuPSR7cnVufSZuYW1lPSR7dGVuc29yTmFtZX1gXG4gICAgKTtcbiAgICB4aHIub25lcnJvciA9IChlcnIpID0+IHtcbiAgICAgIGxvZ2dpbmcuc2V0RXJyb3JNZXNzYWdlKHhoci5yZXNwb25zZVRleHQsICdmZXRjaGluZyBib29rbWFya3MnKTtcbiAgICB9O1xuICAgIHhoci5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICBsb2dnaW5nLnNldE1vZGFsTWVzc2FnZShudWxsLCBtc2dJZCk7XG4gICAgICBjb25zdCBib29rbWFya3MgPSBKU09OLnBhcnNlKHhoci5yZXNwb25zZVRleHQpO1xuICAgICAgY2FsbGJhY2soYm9va21hcmtzKTtcbiAgICB9O1xuICAgIHhoci5zZW5kKCk7XG4gIH1cbn1cbiJdfQ==